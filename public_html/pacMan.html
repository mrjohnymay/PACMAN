<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>TODO supply a title</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body id="all">
        <img src="piedra.jpg"    id="piedra"    style="display: none;">
        <img src="tierra.jpg"       id="tierra"       style="display: none;">
        <img src="pacman.jpg" id="pacman" style="display: none;">
        <img src="fantasma.jpg" id="fantasma" style="display: none;">

        <canvas id="espai" width="900" height="900"> </canvas>
        <div>TODO write content</div>
                <script>

            mapa = new Array(30);

            mapa[0] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            mapa[1] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            mapa[2] = [0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 0];
            mapa[3] = [0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0];
            mapa[4] = [0, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0];
            mapa[5] = [0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0];
            mapa[6] = [0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 0];
            mapa[7] = [0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0];
            mapa[8] = [0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0];
            mapa[9] = [0, 0, 1, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0];
            mapa[10] = [0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0];
            mapa[11] = [0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0];
            mapa[12] = [0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 0, 1, 0, 0];
            mapa[13] = [0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 1, 0, 0, 1, 0, 0];
            mapa[14] = [0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0];
            mapa[15] = [0, 0, 1, 1, 0, 1, 1, 1, 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 0];
            mapa[16] = [0, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0];
            mapa[17] = [0, 0, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0];
            mapa[18] = [0, 0, 1, 0, 0, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 0, 0];
            mapa[19] = [0, 0, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 0, 0, 0, 0, 1, 0, 1, 0, 0, 1, 0, 0, 0, 1, 0, 0];
            mapa[20] = [0, 0, 0, 1, 1, 1, 0, 1, 0, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0];
            mapa[21] = [0, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 0, 0, 0];
            mapa[22] = [0, 0, 1, 0, 0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 0];
            mapa[23] = [0, 0, 1, 0, 1, 1, 0, 1, 1, 1, 0, 1, 0, 1, 1, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0];
            mapa[24] = [0, 0, 1, 0, 1, 0, 0, 0, 0, 1, 0, 1, 0, 1, 0, 0, 1, 0, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 0, 0];
            mapa[25] = [0, 0, 1, 0, 1, 0, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 0, 1, 0, 1, 1, 1, 0, 1, 1, 1, 0, 0, 0];
            mapa[26] = [0, 0, 1, 0, 1, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            mapa[27] = [0, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0];
            mapa[28] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];
            mapa[29] = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

            fantasma1 = new Array(3);
            fantasma2 = new Array(3);
            fantasma3 = new Array(3);
            jugador = new Array(4);

            //mapa[jugador[0]][jugador[1]] = 3;

            inicializarObjeto(fantasma1);
            inicializarObjeto(fantasma2);
            inicializarObjeto(fantasma3);
            inicializarObjeto(jugador);

            fantasma1[2] = asignarDireccion(fantasma1);
            fantasma2[2] = asignarDireccion(fantasma2);
            fantasma3[2] = asignarDireccion(fantasma3);
            jugador[2] = asignarDireccion(jugador);
            mover(jugador);

            //mostrarTablero();
            var a = setInterval(movimiento, 150);
            var element = document.getElementById("all");
            element.addEventListener("keydown", notificaObservador);

            function movimiento() {
                //jugador[3] = element;
                direccion(fantasma1);
                direccion(fantasma2);
                direccion(fantasma3);
                entradaDireccion();
                moverJugador(jugador);
                //mapa[ob[0]][ob[1]] = 2;
                //mapa[ob[0]][ob[1]] = 1;
                pinta();
                //mostrarTablero();
                mapa[fantasma1[0]][fantasma1[1]] = 2;
                mapa[fantasma2[0]][fantasma2[1]] = 2;
                mapa[fantasma3[0]][fantasma3[1]] = 2;
                if (chocan() === true) {
                    alert("Has perdido");
                    clearInterval(a);
                }
                mapa[jugador[0]][jugador[1]] = 3;
                //refresh();
                /*document.write(fantasma1[0] + " " + fantasma1[1] + " " + fantasma1[2] + "<br>");
                 document.write(fantasma2[0] + " " + fantasma2[1] + " " + fantasma2[2] + "<br>");
                 document.write(fantasma3[0] + " " + fantasma3[1] + " " + fantasma3[2] + "<br>");
                 document.write(jugador[0] + " " + jugador[1] + " " + jugador[2] + jugador[3] + "<br>");
                 document.write(chocan() + "<br>");*/
                pinta();
                //mostrarTablero();
                //chocan();
                mapa[fantasma1[0]][fantasma1[1]] = 1;
                mapa[fantasma2[0]][fantasma2[1]] = 1;
                mapa[fantasma3[0]][fantasma3[1]] = 1;
                mapa[jugador[0]][jugador[1]] = 1;
            }
            
            function entradaDireccion(){
                if (jugador[3] === "ArrowUp" && (mapa[jugador[0]][jugador[1]-1] === 1)){
                    jugador[2] = "ar";
                }
                if (jugador[3] === "ArrowRight" && (mapa[jugador[0]+1][jugador[1]] === 1)){
                    jugador[2] = "de";
                }
                if (jugador[3] === "ArrowDown" && (mapa[jugador[0]][jugador[1]+1] === 1)){
                    jugador[2] = "ab";
                }
                if (jugador[3] === "ArrowLeft" && (mapa[jugador[0]-1][jugador[1]] === 1)){
                    jugador[2] = "iz";
                }
            }
            
            function direccion(ob) {
                var dir = ob[2];
                
                if (dir === "ar") {
                    if ((mapa[parseInt(ob[0] - 1)][ob[1]]) === 0 || esCruilla(ob) === true) {
                        ob[2] = asignarDireccion(ob);
                        mover(ob);
                    } else {
                        mover(ob);
                    }
                }
                if (dir === "ab") {
                    if ((mapa[parseInt(ob[0] + 1)][ob[1]]) === 0 || esCruilla(ob) === true) {
                        ob[2] = asignarDireccion(ob);
                        mover(ob);
                    } else {
                        mover(ob);
                    }
                }
                if (dir === "de") {
                    if ((mapa[ob[0]][parseInt(ob[1] + 1)]) === 0 || esCruilla(ob) === true) {
                        ob[2] = asignarDireccion(ob);
                        mover(ob);
                    } else {
                        mover(ob);
                    }
                }
                if (dir === "iz") {
                    if ((mapa[ob[0]][parseInt(ob[1] - 1)]) === 0 || esCruilla(ob) === true) {
                        ob[2] = asignarDireccion(ob);
                        mover(ob);
                    } else {
                        mover(ob);
                    }
                }
            }

            function mover(ob) {
                if (ob[2] === "ar") {
                    ob[0] = parseInt(ob[0] - 1);
                } else if (ob[2] === "ab") {
                    ob[0] = parseInt(ob[0] + 1);
                } else if (ob[2] === "de") {
                    ob[1] = parseInt(ob[1] + 1);
                } else if (ob[2] === "iz") {
                    ob[1] = parseInt(ob[1] - 1);
                }
            }
            
            function moverJugador(ob) {
                if (ob[2] === "ar" && (mapa[jugador[0]][jugador[1]-1] === 1)) {
                    ob[1] = ob[1] - 1;
                }
                if (ob[2] === "ab" && (mapa[jugador[0]][jugador[1]+1] === 1)) {
                    ob[1] = ob[1] + 1;
                }
                if (ob[2] === "de"&& (mapa[jugador[0]+1][jugador[1]] === 1)) {
                    ob[0] = ob[0] + 1;
                }
                if (ob[2] === "iz"&& (mapa[jugador[0]-1][jugador[1]] === 1)) {
                    ob[0] = ob[0] - 1;
                }
            }

            function inicializarObjeto(ob) {
                var x = 0;
                var y = 0;

                while (mapa[x][y] === 0 || mapa[x][y] === 2 || mapa[x][y] === 3) {
                    x = Math.floor(Math.random() * 30);
                    y = Math.floor(Math.random() * 30);
                }

                ob[0] = x;
                ob[1] = y;
            }

            function asignarDireccion(ob) {
                var al;

                do {
                    al = random();
                } while (esPared(al, ob));

                if (al === 0) {
                    return "ar";
                } else if (al === 2) {
                    return "de";
                } else if (al === 1) {
                    return "ab";
                } else if (al === 3) {
                    return "iz";
                }
            }

            function esPared(al, ob) {
                var ar = mapa[ob[0] - 1][ob[1]];
                var ab = mapa[ob[0] + 1][ob[1]];
                var de = mapa[ob[0]][ob[1] + 1];
                var iz = mapa[ob[0]][ob[1] - 1];

                if (al === 0 && ar === 0) {
                    return true;
                } else if (al === 1 && ab === 0) {
                    return true;
                } else if (al === 2 && de === 0) {
                    return true;
                } else if (al === 3 && iz === 0) {
                    return true;
                } else {
                    return false;
                }
            }

            function esCruilla(ob) {
                var ar = mapa[ob[0] - 1][ob[1]];
                var ab = mapa[ob[0] + 1][ob[1]];
                var de = mapa[ob[0]][ob[1] + 1];
                var iz = mapa[ob[0]][ob[1] - 1];

                var c = 0;

                if (ar === 1) {
                    c++;
                }
                if (ab === 1) {
                    c++;
                }
                if (de === 1) {
                    c++;
                }
                if (iz === 1) {
                    c++;
                }

                if (c > 2) {
                    return true;
                } else {
                    return false;
                }
            }

            function chocan() {
                if ((mapa[jugador[0] - 1][jugador[1]] === 2) || (mapa[jugador[0]][jugador[1]] === 2)) {
                    return true;
                }
                if ((mapa[jugador[0] + 1][jugador[1]] === 2) || (mapa[jugador[0]][jugador[1]] === 2)) {
                    return true;
                }
                if ((mapa[jugador[0]][jugador[1] + 1] === 2) || (mapa[jugador[0]][jugador[1]] === 2)) {
                    return true;
                }
                if ((mapa[jugador[0]][jugador[1] - 1] === 2) || (mapa[jugador[0]][jugador[1]] === 2)) {
                    return true;
                }
            }

            /*function asignarDireccion(ob) {
             //var ar = parseInt(ob[0] - 1);
             //var ab = parseInt(ob[0] + 1);
             //var de = parseInt(ob[1] + 1);
             //var iz = parseInt(ob[1] - 1);
             //var al = 99;
             var dir;
             
             while (((al === 0) && ((mapa[parseInt(ob[0]-1)][ob[1]]) === 0)) || ((al === 1) && ((mapa[parseInt(ob[0]+1)][ob[1]]) === 0)) || ((al === 2) && ((mapa[ob[0]][parseInt(ob[1]+1)]) === 0)) || ((al === 3) && ((mapa[ob[0]][parseInt(ob[1]-1)]) === 0))) {
             al = random();
             
             if (al === 0){
             dir = "ar";
             }
             if (al === 1){
             dir = "ab";
             }
             if (al === 2){
             dir = "de";
             }
             if (al === 3){
             dir = "iz";
             }
             }
             
             return dir;
             }*/

            function random() {
                return Math.floor(Math.random() * 4);
            }

            /*function mostrarTablero() {
             for (var i = 0; i < mapa[0].length; i++) {
             for (var j = 0; j < mapa.length; j++) {
             if (mapa[i][j] === 0) {
             document.write("<span style='background-color:red; color: red;'>" + mapa[i][j] + " </span>");
             } else if (mapa[i][j] === 2) {
             document.write("<span style='background-color:purple; color: purple;'>" + mapa[i][j] + " </span>");
             } else if (mapa[i][j] === 3) {
             document.write("<span style='background-color:yellow; color: yellow;'>" + mapa[i][j] + " </span>");
             } else {
             document.write("<span style='color: white;'>" + mapa[i][j] + " </span>");
             }
             }
             document.write("<br>");
             }
             }*/

            function refresh() {
                document.body.innerHTML = " ";
            }

            function notificaObservador(e) {
                jugador[3] = e.key;
                console.log(jugador[2]);
                console.log(jugador[3]);
            }

            function pinta()
            {
                var canvas = document.getElementById("espai");
                var ctx = canvas.getContext("2d");
                var img;
                for (var i = 0; i < mapa.length; i++)
                {
                    for (var j = 0; j < mapa[i].length; j++)
                    {
                        if (mapa[i][j] === 0) {
                            img = document.getElementById("piedra");
                        } else if (mapa[i][j] === 1) {
                            img = document.getElementById("tierra");
                        } else if (mapa[i][j] === 2) {
                            img = document.getElementById("fantasma");
                        } else {
                            img = document.getElementById("pacman");
                        }
                        ctx.drawImage(img, i * 30, j * 30, 30, 30);
                    }
                }
            }

            //document.write(fantasma1[0] + " " + fantasma1[1] + " " + fantasma1[2] + "<br>");
            //document.write(fantasma2[0] + " " + fantasma2[1] + " " + fantasma2[2] + "<br>");
            //document.write(fantasma3[0] + " " + fantasma3[1] + " " + fantasma3[2] + "<br>");
        </script>
    </body>
</html>
